---
- hosts: api_prod
  vars_files:
    - vars.yml
  gather_facts: false
  become: yes

  tasks:
    - name: Install system packages
      apt:
        pkg: "{{ item }}"
        update-cache: yes
      with_items: "{{ system_packages }}"

    - name: Clean repository directory
      file:
        state: absent
        path: "{{ install_root }}/{{ project_name }}"

    - name: Clone/pull project repo
      git:
        repo: "{{ repository_url }}"
        dest: "{{ install_root }}/{{ project_name }}"
        accept_hostkey: yes
        force: yes

    # - name: Apply django configuration
    #   template:
    #     src: settings.j2
    #     dest: "{{ install_root }}/{{ project_name }}/{{ project_name }}/settings.py"

    # Run environment
    - name: Rebuild api image
      command: docker-compose build -f provision/prod/docker-compose.yml
      become: true
      args:
        chdir: "{{ install_root }}/{{ project_name }}"

    - name: Create containers
      command: docker-compose up -d -f provision/prod/docker-compose.yml
      become: true
      args:
        chdir: "{{ install_root }}/{{ project_name }}"

    # - name: Make django migrations
    #   django_manage:
    #     command: "makemigrations message user"
    #     app_path: "{{ install_root }}/{{ project_name }}"
    #     virtualenv: "{{ install_root }}/{{ project_name }}/mdenv"
    #
    # - name: Apply django migrations
    #   django_manage:
    #     command: migrate
    #     app_path: "{{ install_root }}/{{ project_name }}"
    #     virtualenv: "{{ install_root }}/{{ project_name }}/mdenv"
    #
    # - name: Collect project static files
    #   django_manage:
    #     command: collectstatic
    #     app_path: "{{ install_root }}/{{ project_name }}"
    #     virtualenv: "{{ install_root }}/{{ project_name }}/mdenv"

    # Check if is running
